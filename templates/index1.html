<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisión de Calidad</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        window.onload = function() {
            var today = new Date();
            var date = today.getFullYear() + '-' + 
                       (today.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                       today.getDate().toString().padStart(2, '0');
            document.querySelector('[name="fecha"]').value = date;

            function actualizarHora() {
                var now = new Date();
                var hours = now.getHours().toString().padStart(2, '0');
                var minutes = now.getMinutes().toString().padStart(2, '0');
                var time = hours + ':' + minutes;
                document.querySelector('[name="hora"]').value = time;
            }

            actualizarHora();
            setInterval(actualizarHora, 60000);
        };

        function toggleCremaSubmenu() {
            var productoSelect = document.querySelector('[name="producto"]');
            var cremaMenu = document.getElementById('crema-submenu');
            var productoNombre = productoSelect.value;

            if (productoNombre) {
                $.get('/get_relacionados_nombre/' + encodeURIComponent(productoNombre), function(data) {
                    console.log("Productos relacionados:", data);
                    var relacionados = data;
                    var select = $('#crema-submenu select');
                    select.empty();
                    select.append('<option value="">Seleccione Opción</option>');
                    if (relacionados.length === 0) {
                        console.log("No se encontraron productos relacionados para:", productoNombre);
                        cremaMenu.style.display = 'none';
                    } else {
                        relacionados.forEach(function(rel) {
                            select.append('<option value="' + rel + '">' + rel + '</option>');
                        });
                        cremaMenu.style.display = 'block';
                    }
                }).fail(function(xhr, status, error) {
                    console.log("Error al cargar productos relacionados:", error);
                    cremaMenu.style.display = 'none';
                });
            } else {
                cremaMenu.style.display = 'none';
                $('#crema-submenu select').empty().append('<option value="">Seleccione Opción</option>');
            }
        }
    </script>
</head>
<body>
    <div class="container mt-4">
        <h2 class="mb-4">Registro de Revisiones de Calidad</h2>
        
        <form action="/add" method="post" class="mb-4">
            <div class="row g-3">
                <div class="col-md-1">
                    <input type="date" name="fecha" class="form-control" required>
                </div>
                <div class="col-md-1">
                    <input type="time" name="hora" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <select name="producto" class="form-control" required onchange="toggleCremaSubmenu()">
                        <option value="">Seleccione Producto</option>
                        {% for producto in productos %}
                            <option value="{{ producto[1] }}">{{ producto[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="crema-submenu" class="col-md-2" style="display: none;">
                    <select name="tipo_crema" class="form-control">
                        <option value="">Seleccione Opción</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <input type="text" name="lote" class="form-control" placeholder="Lote" required>
                </div>
                <div class="col-md-1">
                    <input type="text" name="odp" class="form-control" placeholder="ODP" required>
                </div>
                <div class="col-md-1">
                    <input type="checkbox" name="etiquetas_de_identificacion" value="1"> Etiquetas de Identificación
                </div>
                <div class="col-md-1">
                    <input type="checkbox" name="materia_primas_identificadas" value="1"> Materia Primas Identificadas
                </div>
                <div class="col-md-1">
                    <input type="checkbox" name="limpieza_del_area" value="1"> Limpieza del Área
                </div>
                <div class="col-md-1">
                    <input type="checkbox" name="orden_de_area" value="1"> Orden de Área
                </div>
                <div class="col-md-1">
                    <input type="checkbox" name="limpieza_de_utensilitos" value="1"> Limpieza de Utensilitos
                </div>
                <div class="col-md-1">
                    <input type="checkbox" name="orden_del_almacen" value="1"> Orden del Almacén
                </div>
                <div class="col-md-2">
                    <select name="inspector_de_calidad" class="form-control">
                        <option value="">Seleccione Inspector</option>
                        {% for inspector in inspectores %}
                            <option value="{{ inspector[1] }}">{{ inspector[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="text" name="observaciones" class="form-control" placeholder="Observaciones">
                </div>
                <div class="col-md-12 text-center">
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </div>
            </div>
        </form>

        <!-- Botón para descargar el PDF -->
        <div class="mb-3">
            <a href="/download_pdf" class="btn btn-success">Descargar PDF</a>
			<a href="/download_excel" class="btn btn-primary">Descargar Excel</a>
        </div>
		
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Fecha de Revisión</th>
                    <th>Hora</th>
                    <th>Producto</th>
                    <th>Lote</th>
                    <th>ODP</th>
                    <th>Etiquetas de Identificación</th>
                    <th>Materia Primas Identificadas</th>
                    <th>Limpieza del Área</th>
                    <th>Orden de Área</th>
                    <th>Limpieza de Utensilitos</th>
                    <th>Orden del Almacén</th>
                    <th>Inspector de Calidad</th>
                    <th>Observaciones</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for review in reviews %}
                <tr>
                    <td>{{ review[1] }}</td>
                    <td>{{ review[2] }}</td>
                    <td>{{ review[3] }}</td>
                    <td>{{ review[4] }}</td>
                    <td>{{ review[5] }}</td>
                    <td>{{ '✓' if review[6] == 1 or review[6] == '1' else '✗' }}</td>
                    <td>{{ '✓' if review[7] == 1 or review[7] == '1' else '✗' }}</td>
                    <td>{{ '✓' if review[8] == 1 or review[8] == '1' else '✗' }}</td>
                    <td>{{ '✓' if review[9] == 1 or review[9] == '1' else '✗' }}</td>
                    <td>{{ '✓' if review[10] == 1 or review[10] == '1' else '✗' }}</td>
                    <td>{{ '✓' if review[11] == 1 or review[11] == '1' else '✗' }}</td>
                    <td>{{ review[12] }}</td>
                    <td>{{ review[13] }}</td>
                    <td>
                        <a href="/delete/{{ review[0] }}" class="btn btn-danger btn-sm">Eliminar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>
</html>